version: '3.8'

services:
  registry:
    build:
      context: .
      dockerfile: Dockerfile.registry
    ports:
      - "9000:9000"  # P2P port
      - "8000:8000"  # HTTP port
    networks:
      - p2p-net
    healthcheck:
      test: ["CMD", "grpcurl", "-plaintext", "-import-path", "/app/proto", "-proto", "/app/proto/registry.proto", "localhost:8000", "registry.Registry/GetRegistryID"]
      interval: 10s
      timeout: 5s
      retries: 3

  operator1:
    build:
      context: .
      dockerfile: Dockerfile.operator
    networks:
      - p2p-net
    depends_on:
      registry:
        condition: service_healthy
    entrypoint: ["/bin/sh", "/app/start-operator.sh"]

  operator2:
    build:
      context: .
      dockerfile: Dockerfile.operator
    networks:
      - p2p-net
    depends_on:
      registry:
        condition: service_healthy
    entrypoint: ["/bin/sh", "/app/start-operator.sh"]

  operator3:
    build:
      context: .
      dockerfile: Dockerfile.operator
    networks:
      - p2p-net
    depends_on:
      registry:
        condition: service_healthy
    entrypoint: ["/bin/sh", "/app/start-operator.sh"]

networks:
  p2p-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16 